"use strict";$.widget("tompit.tpIde",{options:{selection:{explorerNode:null,view:null},designer:{active:null},globalization:{language:null},properties:{saveMode:"instant",state:[],title:document.title},state:[]},_create:function(){this.initialize()},initialize:function(){this.initializeExplorer()},setLanguage:function(value){this.options.globalization.language=value},setState:function(property,value){var exists=!1;$.each(this.options.state,function(i,v){if(v.property===property)return v.value=value,exists=!0,!1});exists||this.options.state.push({property:property,value:value})},getState:function(property){var r=null;return $.each(this.options.state,function(i,v){if(v.property===property)return r=v.value,!1}),r},initializeExplorer:function(e){var instance=this;this._initializeExplorerNodes(e);$("#exBtnCollapse").unbind("click");$("#exBtnCollapse").click(function(){var nodes=$('[data-kind="explorer-node"]'),root,firstLevel;$.each(nodes,function(i,v){var icon=$(v).find("span [data-fa-i2svg]"),group;icon.removeClass("fa-chevron-down").addClass("fa-chevron-right");group=$(v).children('[data-kind="explorer-group"][data-group]');group.addClass("collapse")});root=$("#devExplorerNodes");firstLevel=root.children('[data-kind="explorer-node"]');firstLevel.length===0?instance.selectNode(null):instance.selectNode({path:firstLevel.attr("data-id")})})},_initializeExplorerNodes:function(e){var d,container,instance,draggables,droppables;e=$.extend({selector:null,path:null,mode:"children"},e);d=null;e.selector===null?d=this.element:(container=null,e.path!==null&&(container=this._findElement(e.path)),d=container===null?e.selector:e.mode==="children"?$(e.selector,container):container);instance=this;$('[data-kind="toggler"]',d).click(function(){var target=$(this),icon=target.find("[data-fa-i2svg]"),node=target.closest("[data-id]"),id=node.attr("data-id"),path=instance._resolvePath(target),group,loaded;icon.toggleClass("fa-chevron-right").toggleClass("fa-chevron-down");group=node.children('[data-kind="explorer-group"][data-group]');icon.hasClass("fa-chevron-down")?(group.removeClass("collapse"),loaded=group.attr("data-loaded"),loaded!=="true"&&instance._loadExplorerChildren({path:path})):group.addClass("collapse")});$(".dev-explorer-node-text",d).click(function(){instance.selectNode({target:$(this),scroll:!1})});draggables=$('[data-kind="explorer-node"][data-static="false"]',d.parent());$.each(draggables,function(i,v){$(v).data("draggable")&&$(v).draggable("destroy")});droppables=$('[data-kind="explorer-node"][data-container="true"]',d.parent());$.each(droppables,function(i,v){$(v).data("droppable")&&$(v).droppable("destroy")});$('[data-kind="explorer-node"][data-static="false"]',d.parent()).draggable({containment:"#devExplorerNodes",scroll:!0,scrollSpeed:100,cursor:"move",opacity:.7,revert:!0,revertDuration:0,create:function(){instance.options.selection.dragPath=instance._resolvePath($(this));$(this).attr("origin",$(this).closest('[data-container="true"]').attr("data-id"))}});$('[data-kind="explorer-node"][data-container="true"]',d.parent()).droppable({greedy:!0,accept:function(){var att=$(this).attr("data-container");return att===null?!1:att==="true"},drop:function(event,ui){var folder=$(this).attr("data-id"),id=ui.draggable.attr("data-id"),origin=ui.draggable.attr("origin"),path=instance.options.selection.dragPath;origin!==folder&&ide.ideAction({data:{action:"move",id:id,folder:folder,path:path},onComplete:function(){var originTarget;origin!==null&&(originTarget=$('[data-kind="explorer-node"][data-id="'+origin+'"]'));var target=$('[data-kind="explorer-node"][data-id="'+folder+'"]'),originPath=instance._resolvePath(originTarget),targetPath=instance._resolvePath(target);originPath.indexOf("/")>-1&&(originPath=originPath.substr(0,originPath.lastIndexOf("/")));instance.refreshExplorer({path:originPath,mode:"item"});$(this).remove();instance.refreshExplorer({path:targetPath,mode:"item"})}})}})},selectNode:function(e){e=$.extend({target:null,path:null,scroll:!0},e);e.target===null&&e.path!==null&&(e.target=this._findElement(e.path));var path=this._resolvePath(e.target);(path!==this.options.selection.explorerNode||typeof e.force!="undefined"&&e.force!==!1)&&(this.options.selection.explorerNode=path,this.draw(),this.loadSection({section:"designer"}),this.setSelection(),document.title=e.target.find('span[data-kind="documentName"]').html()+" ("+this.options.properties.title+")",e.scroll&&this.scrollToNode(e))},_syncNode:function(s,e){var element=s._findElement(e.target);s.options.selection.explorerNode=this._resolvePath(element);s.draw();s.loadSection({section:"designer"});this.setSelection();e.scroll&&$("#devExplorer").animate({scrollTop:element.offset().top},1e3)},scrollToNode:function(e){$("#devExplorer").animate({scrollTop:e.target.offset().top},1e3)},setSelection:function(path){this.loadSection({section:"selection",path:path})},refreshExplorer:function(e){this._loadExplorerChildren(e)},expandCurrent:function(){this.expand({path:this.options.selection.explorerNode})},collapseCurrent:function(){var element=this._findElement(this.options.selection.explorerNode),icon,group;element!==null&&(icon=element.children(".dev-explorer-node-content").find("span [data-fa-i2svg]"),icon.length!==0)&&(icon.removeClass("fa-chevron-down").addClass("fa-chevron-right"),group=element.children('[data-kind="explorer-group"][data-group]'),group.addClass("collapse"))},selectNext:function(){var element=this._findElement(this.options.selection.explorerNode),group=element.children('[data-kind="explorer-group"][data-group]'),path,next,p,parentNode,sibling,spath;if(group.length>0&&!group.hasClass("collapse")&&group.children().length>0)path=this._resolvePath($('[data-kind="explorer-node"]',group)),this.selectNode({target:this._findElement(path)});else if(next=element.next(),next.length>0)p=this._resolvePath(next),this.selectNode({target:this._findElement(p)});else for(parentNode=element.parent().closest('[data-kind="explorer-node"]'),sibling=null;sibling===null||sibling.length===0;){if(parentNode.length===0)return;if(sibling=parentNode.next(),sibling.length===0)parentNode=parentNode.parent().closest('[data-kind="explorer-node"]');else{spath=this._resolvePath(sibling);this.selectNode({target:this._findElement(spath)});return}}},selectPrevious:function(){var element=this._findElement(this.options.selection.explorerNode),prevSibling,group,nested,nestedGroup,last;if(element.length!==0)if(prevSibling=element.prev(),prevSibling.length===0){if(prevSibling=element.parent().closest('[data-kind="explorer-node"]'),prevSibling.length===0)return;this.selectNode({target:this._findElement(this._resolvePath(prevSibling))})}else{for(group=prevSibling.children('[data-kind="explorer-group"]');group.length>0&&!group.hasClass("collapse")&&group.children().length>0;)if(nested=group.children('[data-kind="explorer-node"]'),nested.length>0)if(nestedGroup=nested.last().children('[data-kind="explorer-group"]'),nestedGroup.length>0&&!nestedGroup.hasClass("collapse")&&nestedGroup.children().length>0)group=nestedGroup;else break;else break;group.length>0?(last=group.children('[data-kind="explorer-node"]').last(),this.selectNode({target:this._findElement(this._resolvePath(last))})):this.selectNode({target:this._findElement(this._resolvePath(prevSibling))})}},expand:function(e){var element,icon,group,loaded;(e=$.extend({path:null,onComplete:function(){return!1}},e),element=this._findElement(e.path),element.length!==0)&&(icon=element.children(".dev-explorer-node-content").find("span [data-fa-i2svg]"),icon.removeClass("fa-chevron-right").addClass("fa-chevron-down"),group=element.children('[data-kind="explorer-group"][data-group]'),group.removeClass("collapse"),loaded=group.attr("data-loaded"),loaded!=="true"?this._loadExplorerChildren({path:e.path,onComplete:e.onComplete}):e.onComplete())},expandTo:function(e){var tokens,instance,currentTokens,i,fullPath,target,current;if(e=$.extend({path:null,select:!0,selectedId:null,current:null},e),tokens=e.path.split("/"),instance=this,e.current!==null){for(currentTokens=e.current.split("/"),i=0;i<currentTokens.length;i++)tokens.shift();if(tokens.length===0){e.select&&(fullPath=e.path,e.selectedId!==null&&e.selectedId.length>0&&(fullPath+="/"+e.selectedId),target=this._findElement(fullPath),this.selectNode({target:target}));return}current=e.current+"/"+tokens.shift()}else current=tokens.shift();instance.expand({path:current,onComplete:function(){instance.expandTo({path:e.path,select:e.select,selectedId:e.selectedId,current:current})}})},_checkSelection:function(e){if(this.options.selection.explorerNode!==null){var target=this._findElement(this.options.selection.explorerNode);target.length===0?(this.options.selection.explorerNode=this.options.selection.explorerNode.substr(0,this.options.selection.explorerNode.lastIndexOf("/")),this._checkSelection({select:!0})):e.select&&this.selectNode({target:target,force:!0})}},_loadExplorerChildren:function(e){var url=new tompit.devUrl,instance=this;e=$.extend({onComplete:function(){return!1},select:!1,async:!0,depth:0,mode:"children"},e);tompit.post({url:url.environment("dom"),contentType:"application/json; charset=utf-8",dataType:"json",async:e.async,data:{path:e.path,depth:e.depth,mode:e.mode,language:instance.options.globalization.language},progress:tompit.findProgress(this.element),onSuccess:function(data,request){var id=e.path.substr(e.path.lastIndexOf("/")+1),s=null,target,group,target1;e.mode==="children"?(target=instance._findElement(e.path),s='[data-kind="explorer-group"][data-group="'+id+'"]',group=target.children(s),group.attr("data-loaded","true"),group.html(data)):(target1=instance._findElement(e.path),s='[data-kind="explorer-node"][data-id="'+id+'"]',$(target1).replaceWith(data));instance._initializeExplorerNodes({selector:s,path:e.path,mode:e.mode});instance.draw();e.select&&instance.expandTo({path:e.path,select:!0});instance._checkSelection({select:!1});e.onComplete(data,request)}})},draw:function(){if($(".dev-explorer-node-content.active",this.element).removeClass("active"),this.options.selection.explorerNode!==null){var selected=this._findElement(this.options.selection.explorerNode);selected.children(".dev-explorer-node-content").addClass("active")}},saveProperty:function(options){var exists;if(this.options.properties.saveMode==="batch"){exists=!1;$.each(this.options.properties.state,function(i,v){if(v.property===options.data.property)return v.value=options.data.value,exists=!0,!1});exists||this.options.properties.state.push({property:options.data.property,value:options.data.value});return}var url=new tompit.devUrl,instance=this,data=$.extend({language:this.options.globalization.language,selectionId:this.options.selection.id,designerSelectionId:this.options.selection.designerId},options.data);tompit.post({url:url.environment("save"),contentType:"application/json; charset=utf-8",dataType:"json",data:data,progress:tompit.findProgress(this.element),onError:function(request,status,error){if(typeof options.onError!="undefined")return options.onError(request,status,error)},onSuccess:function(data,status,request){var result,invalidate,path,designerPath;if(typeof options.onComplete!="undefined")options.onComplete(data,request);result=request.getResponseHeader("result");result!==null&&result==="1"?instance.statusText('<span class="text-info"><i class="fal fa-check-circle"><\/i> \''+options.data.property+"' saved.<\/span>"):tompit.warning("Property has not been saved. This is possibly due to the not supported server implementation.","Save");invalidate=request.getResponseHeader("invalidate");invalidate!==null&&(path=request.getResponseHeader("path"),designerPath=request.getResponseHeader("designerPath"),instance.refreshSections({sections:invalidate,path:path,designerPath:designerPath}));instance.options.designer.active!==null&&$.isFunction(instance.options.designer.active.idePropertySaved)&&instance.options.designer.active.idePropertySaved(data)}})},refreshDesigner:function(){var data={path:this.selectedPath(),sections:"designer"};this.refreshSections(data)},refreshSections:function(e){var sec=e.sections.toLowerCase().split(",").map(function(item){return item.trim()}),explorer=sec.indexOf("explorer")>-1,designer=sec.indexOf("designer")>-1,selection=sec.indexOf("selection")>-1,properties=sec.indexOf("properties")>-1,events=sec.indexOf("events")>-1,toolbox=sec.indexOf("toolbox")>-1,property=sec.indexOf("property")>-1,all=sec.indexOf("all")>-1,path,depth;all?this.loadSection({section:"all",path:e.path,data:e.data,onComplete:e.onComplete}):(explorer&&(path=e.path,depth=0,typeof e.explorerPath!="undefined"&&(path=e.explorerPath,1),this.refreshExplorer({path:path,depth:depth,mode:"item",onComplete:e.onComplete})),designer&&this.loadSection({section:"designer",path:e.path,data:e.data,onComplete:e.onComplete}),selection?this.loadSection({section:"selection",path:e.path,data:e.data,onComplete:e.onComplete}):(properties?this.loadSection({section:"properties",path:e.path,data:e.data,onComplete:e.onComplete}):property&&this.loadSection({section:"property",path:e.path,data:e.data,onComplete:e.onComplete}),events&&this.loadSection({section:"events",path:e.path,data:e.data,onComplete:e.onComplete}),toolbox&&this.loadSection({section:"toolbox",path:e.path,data:e.data,onComplete:e.onComplete})))},clearDescription:function(){$("#devPropertyDescription").empty()},setDescription:function(title,description){$("#devPropertyDescription").html("<strong>"+title+"<\/strong><br/>"+description)},setSelectionId:function(id){this.options.selection.id=id},setDesignerSelectionId:function(id){this.options.selection.designerId=id},statusText:function(html){$("#devStatus").html(html)},loadSection:function(e){var url=new tompit.devUrl,instance=this,data;e=$.extend({section:null,path:null,data:null},e);e.path===null&&(e.path=this.selectedPath());data=$.extend(e.data,{path:e.path,section:e.section,language:instance.options.globalization.language});tompit.post({url:url.environment("Section"),contentType:"application/json; charset=utf-8",dataType:"json",data:data,progress:tompit.findProgress(this.element),onSuccess:function(data,status,request){var s=request.getResponseHeader("section").toLowerCase();if(s==="all"?($("#ide").html(data),instance.initialize()):s==="explorer"?($("#devExplorerNodes").html(data),instance.initializeExplorer()):s==="selection"?$("#devSelection").html(data):s==="properties"?$("#devTabPropertyGrid").html(data):s==="events"?$("#devTabEvents").html(data):s==="toolbox"?$("#devTabToolbox").html(data):s==="property"||s==="designer"&&($("#ide").off("toolbarClick"),instance.setActiveDesigner(null),$("#devDesigner").html(data),instance.initializeDesigner()),$.isFunction(e.onComplete))e.onComplete(data,request)}})},selectedPath:function(){var e=this.selectedElement();return e===null||e.length===0?null:this._resolvePath(e)},selectedElement:function(){return this.options.selection.explorerNode===null?null:this._findElement(this.options.selection.explorerNode)},initializeDesigner:function(){var instance=this;$('[data-tp-tag="toolbar-action"]',this.element).click(function(){var e={id:$(this).attr("data-id"),cancel:!1,kind:$(this).attr("data-toolbar-kind"),parameters:{}};instance.element.trigger("toolbarClick",e);e.cancel||instance.designerAction({data:$.extend(e.parameters,{action:e.id})})});tompit.initContainer("#devDesigner")},setPropertySaveMode:function(v){this.options.properties.saveMode=v;this.options.properties.state=[]},getPropertiesState:function(){return this.options.properties.state},elementId:function(target){return $(target).closest("[data-id]").attr("data-id")},setActiveDesigner:function(d){this.options.designer.active=d},designerAction:function(d,progress){return this._action(d,progress,"action")},ideAction:function(d,progress){return this._action(d,progress,"ide")},_action:function(d,progress,action){var url=new tompit.devUrl,instance=this,path=this.selectedPath();return typeof d!="undefined"&&typeof d.data!="undefined"&&typeof d.data.path!="undefined"&&(path=d.data.path),tompit.post({url:url.environment(action),contentType:"application/json; charset=utf-8",dataType:"json",data:$.extend(d.data,{path:path,language:instance.options.globalization.language}),progress:typeof progress=="undefined"||!progress?tompit.findProgress(this.element):null,onSuccess:function(data,status,request){var type=request.getResponseHeader("designerResult");if(instance._handleMessage(request),type===null){if(typeof d.onComplete!="undefined")d.onComplete(data,request);return}if(type==="partial"){if(typeof d.onComplete!="undefined")d.onComplete(data,request)}else if(type==="json"){if(typeof d.onComplete!="undefined")d.onComplete(JSON.parse(data),request)}else if(type==="section"){var designerPath=request.getResponseHeader("designerPath"),path=request.getResponseHeader("path"),sections=request.getResponseHeader("invalidate");sections!==null&&instance.refreshSections({sections:sections,path:path,explorerPath:designerPath,designerPath:designerPath,data:data,onComplete:function(){if($.isFunction(d.onComplete))d.onComplete(data,request)}})}}})},_handleMessage:function(request){var kind=request.getResponseHeader("messageKind"),title,message,explorerPath,instance,options;kind!==null&&(title=request.getResponseHeader("title"),message=request.getResponseHeader("message"),title!==null||message!==null)&&(kind=kind.toLowerCase(),explorerPath=request.getResponseHeader("explorerPath"),instance=this,toastr.clear(),options={timeOut:2500},explorerPath!==null&&(options.onclick=function(){instance.expandTo({path:explorerPath})}),kind==="primary"||kind==="information"||kind==="secondary"?tompit.info(message,title,options):kind==="success"?tompit.success(message,title,options):kind==="warning"?tompit.warning(message,title,options):kind==="danger"&&tompit.danger(message,title,options))},_resolvePath:function(element){for(var path=[],current=element.closest("[data-id]");current.length>0;)path.push(current.attr("data-id")),current=current.parent().closest("[data-id]");return path.reverse().join("/")},_findElement:function(path){for(var container,tokens=path.split("/"),current=null,i=0;i<tokens.length;i++)container=current,container===null&&(container=$("#devExplorerNodes")),current=$('[data-kind="explorer-node"][data-id="'+tokens[i]+'"]',container).first();return current},hideToolbar:function(){$("#devToolbar").addClass("collapse")},showToolbar:function(){$("#devToolbar").removeClass("collapse")},setSelectionView:function(value){this.options.selection.view=value},getSelectionView:function(){return this.options.selection.view},newWindow:function(){}});tompit.DEVDEFAULTS={environmentUrl:null};tompit.DEVGLOBALIZE={environmentUrlNotSet:null};tompit.devUrl=function(){this.environment=function(verb){return(tompit.DEVDEFAULTS.environmentUrl===null&&tompit.clientError(tompit.DEVGLOBALIZE.environmentUrlNotSet),tompit.DEVDEFAULTS.environmentUrl==="/")?tompit.DEVDEFAULTS.environmentUrl+verb:tompit.DEVDEFAULTS.environmentUrl+"/"+verb}},function($){$.widget("tompit.tpTextEditor",{options:{onCreated:function(){return!1},onChanged:function(){return!1},instance:null},_create:function(){this._editors=[]},activateEditor:function(options){var target=this;require(["vs/editor/editor.main"],function(){if(monaco.editor.defineTheme("TomPIT",{base:"vs",inherit:!0,rules:[{background:"f5f5f5"}]}),monaco.editor.setTheme("TomPIT"),target.options.instance!==null)try{typeof target.options.instance.completionItemProvider!="undefined"&&target.options.instance.completionItemProvider.dispose();typeof target.options.instance.signatureHelpProvider!="undefined"&&target.options.instance.signatureHelpProvider.dispose();typeof target.options.instance.hoverProvider!="undefined"&&target.options.instance.hoverProvider.dispose();typeof target.options.instance.codeLensProvider!="undefined"&&target.options.instance.codeLensProvider.dispose();typeof target.options.instance.definitionProvider!="undefined"&&target.options.instance.definitionProvider.dispose();target.options.instance.dispose();target.options.instance=null}catch(e){console.log(e)}options=$.extend({readOnly:!1},options);var src=options.source===null||options.source.length===0?"\n":options.source.join("\n");if(target.options.hasChanged=!1,target.options.instance=monaco.editor.create(document.getElementById(options.elementId),{value:src,language:options.language,lineNumbers:!0,scrollBeyondLastLine:!0,automaticLayout:!0,folding:!0,formatOnPaste:!0,formatOnType:!0,glyphMargin:!0,lineNumbersMinChars:4,parameterHints:!0,wrappingColumn:0,wrappingIndent:"indent",readOnly:options.readOnly}),$.isFunction(options.onCreated))options.onCreated(target.options.instance);target.options.instance.onDidChangeModelContent(()=>{target.options.hasChanged=!0});$("textarea",target.element).on("blur",function(){if(target.options.hasChanged&&typeof options.onChange!="undefined")options.onChange(target.options.instance.getValue())})})},registerCompletionItemProvider:function(language,options){var provider=monaco.languages.registerCompletionItemProvider(language,options);this.options.instance.completionItemProvider=provider},registerSignatureHelpProvider:function(language,options){var provider=monaco.languages.registerSignatureHelpProvider(language,options);this.options.instance.signatureHelpProvider=provider},registerHoverProvider:function(language,options){var provider=monaco.languages.registerHoverProvider(language,options);this.options.instance.hoverProvider=provider},registerCodeLensProvider:function(language,options){var provider=monaco.languages.registerCodeLensProvider(language,options);this.options.instance.codeLensProvider=provider},registerDefinitionProvider:function(language,options){var provider=monaco.languages.registerDefinitionProvider(language,options);this.options.instance.definitionProvider=provider},insertText:function(text){var line=this.options.instance.getPosition(),range=new monaco.Range(line.lineNumber,1,line.lineNumber,1),op={identifier:{major:1,minor:1},range:range,text:text,forceMoveMarkers:!0};this.options.instance.executeEdits("insert-snippet",[op])},getValue:function(){return this.options.instance.getValue()},setValue:function(s){return this.options.instance.setValue(s)},formatDocument:function(){this.options.instance.trigger("format","editor.action.formatDocument")},setMarkers:function(markers){monaco.editor.setModelMarkers(this.options.instance.getModel(),"syntax",markers)},addCommand:function(k,h){return this.options.instance.addCommand(k,h)},addAction:function(k){return this.options.instance.addAction(k)}})}(jQuery);